<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Drive Bağlantı Testi</title>
  <style>
    body{font-family:system-ui, Arial, sans-serif; max-width:720px; margin:24px auto; padding:0 12px}
    button{font-size:16px; padding:10px 14px; border-radius:10px; border:1px solid #ddd; cursor:pointer;}
    #out{white-space:pre-wrap; background:#f7f7f8; padding:12px; border-radius:10px; border:1px solid #eee}
  </style>
</head>
<body>
  <h1>Google Drive’a giriş</h1>
  <p>“Google ile izin ver” butonuna bas, Drive’daki ilk 10 dosyan listelensin.</p>

  <p id="status">Hazırlanıyor…</p>
  <button id="btnAuth">Google ile izin ver</button>
  <button id="btnList" disabled>Drive dosyalarını listele</button>

  <h3>Sonuç</h3>
  <pre id="out"></pre>

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <!-- Google API Client -->
  <script src="https://apis.google.com/js/api.js"></script>
  <script>
    const CLIENT_ID = "80645961616-j77eaun602ks7f2hp61gtd5nc5t70bs9.apps.googleusercontent.com";
    const SCOPES = "https://www.googleapis.com/auth/drive.readonly";
    const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];

    const $ = s => document.querySelector(s);
    const log = m => { $("#out").textContent += (m + "\n"); };
    const setStatus = t => $("#status").textContent = t;

    async function loadGapi() {
      return new Promise(res => gapi.load('client', res));
    }
    async function initGapi() {
      await gapi.client.init({ discoveryDocs: DISCOVERY_DOCS });
      setStatus("GAPI hazır.");
      $("#btnList").disabled = false;
    }

    let tokenClient;
    function initGIS() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: (resp) => {
          if (resp && resp.access_token) {
            gapi.client.setToken({ access_token: resp.access_token });
            setStatus("Oturum açıldı.");
            listFiles();
          } else {
            log("Token alınamadı.");
          }
        }
      });
    }

    async function listFiles() {
      try {
        const r = await gapi.client.drive.files.list({
          pageSize: 10,
          fields: "files(id,name,modifiedTime)"
        });
        const files = r.result.files || [];
        if (files.length === 0) { log("Dosya bulunamadı."); return; }
        log(files.map(f => `${f.name} — ${f.id}`).join("\n"));
      } catch (e) {
        log("Hata: " + (e && e.message ? e.message : e));
      }
    }

    $("#btnAuth").addEventListener("click", () => {
      tokenClient.requestAccessToken({ prompt: 'consent' });
    });
    $("#btnList").addEventListener("click", listFiles);

    (async () => {
      try {
        await loadGapi();
        await initGapi();
        initGIS();
        setStatus("Hazır. İzin ver'e basabilirsin.");
      } catch (e) {
        setStatus("Başlatma hatası");
        log(e && e.message ? e.message : e);
      }
    })();
  </script>
</body>
</html>
