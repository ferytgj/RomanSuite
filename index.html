<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RomanSuite • Google Drive Login</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", sans-serif; }
    body { margin: 24px; }
    .card { max-width: 720px; margin: 0 auto; padding: 20px; border: 1px solid #e5e7eb; border-radius: 14px; box-shadow: 0 2px 10px rgba(0,0,0,.05); }
    .row { display:flex; gap:12px; flex-wrap: wrap; margin: 12px 0; }
    button { padding:10px 14px; border-radius:10px; border:1px solid #d1d5db; cursor:pointer; }
    button:disabled { opacity:.55; cursor: not-allowed; }
    code { background:#f3f4f6; padding:2px 6px; border-radius:6px; }
    ul { padding-left: 18px; }
    .ok { color: #0a7a30; }
    .err { color: #b42318; white-space: pre-wrap; }
    .muted { color:#6b7280; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Google Drive’a giriş</h1>
    <p class="muted">GIS popup akışıyla giriş yapar, Drive’dan ilk 10 dosyayı listeler.</p>

    <div id="status" class="muted">Hazır…</div>

    <div class="row">
      <button id="btn-auth" disabled>Google ile izin ver</button>
      <button id="btn-signout" disabled>Çıkış</button>
      <button id="btn-list" disabled>Drive dosyalarını listele</button>
    </div>

    <h3>Sonuç</h3>
    <ul id="files"></ul>

    <h3>Hata/Günlük</h3>
    <pre id="log" class="err"></pre>

    <p class="muted">Şuradan aç: <code>http://localhost:5000</code> veya <code>https://ferytgj.github.io/RomanSuite/</code></p>
  </div>

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <!-- Google APIs Client (gapi) -->
  <script src="https://apis.google.com/js/api.js"></script>

  <script>
    // ✅ Senin değerlerinle dolduruldu
    const CLIENT_ID = "986010688372-lpvkmv2a60em7ut4poc4kj41eadkg10s.apps.googleusercontent.com";
    const API_KEY   = "AIzaSyCl3bPUDrf06QrXtSSMQZg63O_HYFUiLy4";

    // Sadece okuma yetkisi
    const SCOPES = "https://www.googleapis.com/auth/drive.readonly";
    const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];

    let tokenClient;
    let gapiInited = false;
    let gisInited  = false;

    const el = (id)=>document.getElementById(id);
    const setStatus = (msg, ok)=>{ const s=el("status"); s.textContent=msg; s.className = ok ? "ok" : "muted"; };
    const log = (msg)=>{ el("log").textContent = (el("log").textContent + "\n" + msg).trim(); };

    function gapiLoaded() {
      gapi.load('client', async () => {
        try {
          await gapi.client.init({ apiKey: API_KEY, discoveryDocs: DISCOVERY_DOCS });
          gapiInited = true;
          maybeEnableButtons();
          setStatus("GAPI hazır.", true);
        } catch (e) { log("gapi init hatası: " + (e.message || e)); }
      });
    }
    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        prompt: '',
        callback: (resp) => {
          if (resp.error) { log(JSON.stringify(resp, null, 2)); return; }
          setStatus("Giriş başarılı, erişim verildi.", true);
          el("btn-list").disabled = false;
          el("btn-signout").disabled = false;
        },
      });
      gisInited = true;
      maybeEnableButtons();
      setStatus("GIS hazır.", true);
    }
    function maybeEnableButtons() {
      if (gapiInited && gisInited) el("btn-auth").disabled = false;
    }

    el("btn-auth").onclick = () => {
      el("log").textContent = "";
      tokenClient.requestAccessToken({
        prompt: google.accounts.oauth2.hasGrantedAllScopes ? '' : 'consent'
      });
    };

    el("btn-signout").onclick = () => {
      const token = gapi.client.getToken();
      if (token) {
        google.accounts.oauth2.revoke(token.access_token, () => {
          gapi.client.setToken('');
          setStatus("Çıkış yapıldı.", false);
          el("btn-list").disabled = true;
          el("btn-signout").disabled = true;
        });
      }
    };

    el("btn-list").onclick = async () => {
      try {
        const res = await gapi.client.drive.files.list({
          pageSize: 10,
          fields: "files(id, name, mimeType, modifiedTime)"
        });
        const files = res.result.files || [];
        const ul = el("files");
        ul.innerHTML = "";
        if (!files.length) {
          ul.innerHTML = "<li>Dosya bulunamadı.</li>";
        } else {
          files.forEach(f => {
            const li = document.createElement("li");
            li.textContent = `${f.name} — ${f.mimeType} — ${new Date(f.modifiedTime).toLocaleString()}`;
            ul.appendChild(li);
          });
        }
      } catch (e) {
        log("Drive isteği hatası:\n" + (e.result?.error?.message || e.message || e));
      }
    };

    // Bazı ortamlarda onload tetiklenmezse elle çağır
    if (window.gapi && window.gapi.load) gapiLoaded();
    if (window.google && window.google.accounts) gisLoaded();
  </script>

  <!-- onload fallback (bazı tarayıcılarda güvenli) -->
  <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
  <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>
