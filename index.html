<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RomanSuite – Google Drive Entegre</title>
  <link rel="icon" href="data:," />
  <style>
    :root{--bg:#0f172a;--card:#111827;--ink:#e5e7eb;--mut:#9ca3af;--pri:#10b981;--blue:#0ea5e9}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    header{padding:14px 16px;border-bottom:1px solid #1f2937;display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    h1{margin:0;font-size:20px;font-weight:700;display:flex;align-items:center;gap:8px}
    .badge{display:inline-flex;align-items:center;gap:8px;background:#0b1220;border:1px solid #1f2937;border-radius:14px;padding:10px 14px;font-weight:700;cursor:pointer}
    .badge .i{font-weight:900}
    main{max-width:980px;margin:0 auto;padding:16px}
    .bar{display:flex;flex-wrap:wrap;gap:12px;margin-bottom:14px}
    button{border:0;border-radius:12px;padding:12px 14px;font-weight:700;cursor:pointer}
    .primary{background:var(--pri);color:#052e1b}
    .ghost{background:#0b1220;border:1px solid #1f2937;color:#cfe8db}
    .muted{background:#0b1220;border:1px solid #1f2937;color:var(--mut)}
    .blue{background:var(--blue);color:#042c3a}
    textarea{width:100%;min-height:56vh;background:#0b1220;border:1px solid #1f2937;color:var(--ink);border-radius:14px;padding:16px 14px;line-height:1.6;font-size:18px;resize:vertical;outline:none}
    .hint{color:var(--mut);font-size:13px;margin-top:10px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .input{flex:1;min-width:240px;background:#0b1220;border:1px solid #1f2937;color:var(--ink);border-radius:12px;padding:12px 14px;outline:none}
    .status{font-size:13px;color:var(--mut);margin-left:6px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
</head>
<body>
  <header>
    <h1>📚 RomanSuite</h1>
    <button id="saveDocx" class="badge" title="DOCX olarak indir">
      <span class="i">⬇</span> DOCX İndir
    </button>
  </header>

  <main>
    <!-- Drive / Docs'tan çek -->
    <div class="row" style="margin-bottom:12px">
      <input id="driveUrl" class="input" placeholder="Google Docs veya herkese açık .txt bağlantısını yapıştırın…" />
      <button id="fetchDrive" class="blue">Drive’dan Al</button>
      <span id="fetchStatus" class="status"></span>
    </div>

    <div class="bar">
      <button id="toNovel" class="primary">Roman Formatına Çevir</button>
      <button id="detectHeads" class="ghost">Başlıkları Algıla</button>
      <button id="clear" class="muted">Temizle</button>
    </div>

    <textarea id="editor" placeholder="Metni buraya yapıştır.
Boş satır = yeni paragraf.
Shift+Enter = satır sonu."></textarea>
    <div class="hint">İpuçları: Paragrafları boş satırla ayır. “Roman Formatına Çevir” akıllı tırnak, kısa/uzun tire ve üç nokta gibi düzeltmeler yapar. “DOCX İndir” dosya adını ilk başlıktan alır.</div>
  </main>

  <script>
    const $ = sel => document.querySelector(sel);

    // --- Metin düzenleme yardımcıları ---
    const smarten = t => t
      .replace(/\"([^\"]*)\"/g, '“$1”')
      .replace(/\'([^\']*)\'/g, '‘$1’')
      .replace(/\.{3,}/g, '…')
      .replace(/\s+-\s+/g, ' — ')
      .replace(/--/g, '—');

    const toNovelFormat = (raw) => {
      const parts = raw.replace(/\r\n/g,"\n").trim().split(/\n{2,}/);
      return parts.map(p=>{
        p = p.replace(/[ \t]+\n/g, '\n');
        p = p.replace(/\n(?!\n)/g, ' ');
        p = smarten(p.trim());
        // paragraf başına mini girinti istiyorsan:
        // p = '    ' + p;
        return p;
      }).join("\n\n");
    };

    const detectHeads = (raw) => {
      const lines = raw.split(/\r?\n/);
      return lines.map((ln)=>{
        const s = ln.trim();
        if(!s) return "";
        const words = s.split(/\s+/).length;
        const isAllCaps = s === s.toUpperCase() && /[A-ZÇĞİÖŞÜ]/.test(s);
        if (isAllCaps || words <= 5) return s + "\n";
        return s;
      }).join("\n");
    };

    // --- DOCX oluşturucu (minimal paket) ---
    async function buildDocx(text) {
      const zip = new JSZip();
      const esc = (s)=>s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");

      const paras = (text || " ").split(/\n{2,}/).map(p=>{
        const runs = esc(p).split(/\n/).map(line =>
          `<w:r><w:t xml:space="preserve">${line}</w:t></w:r>`
        ).join(`<w:r><w:br/></w:r>`);
        return `<w:p>${runs}</w:p>`;
      }).join("");

      const documentXml =
`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:document xmlns:wpc="http://schemas.microsoft.com/office/word/2010/wordprocessingCanvas"
 xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
 xmlns:o="urn:schemas-microsoft-com:office:office"
 xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships"
 xmlns:m="http://schemas.microsoft.com/office/officeDocument/2006/math"
 xmlns:v="urn:schemas-microsoft-com:vml"
 xmlns:wp14="http://schemas.microsoft.com/office/word/2010/wordprocessingDrawing"
 xmlns:wp="http://schemas.openxmlformats.org/drawingml/2006/wordprocessingDrawing"
 xmlns:w10="urn:schemas-microsoft-com:office:word"
 xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main"
 xmlns:w14="http://schemas.microsoft.com/office/word/2010/wordml"
 mc:Ignorable="w14 wp14">
  <w:body>
    ${paras}
    <w:sectPr><w:pgSz w:w="11906" w:h="16838"/><w:pgMar w:top="1440" w:right="1440" w:bottom="1440" w:left="1440"/></w:sectPr>
  </w:body>
</w:document>`;

      const stylesXml =
`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:styles xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
  <w:style w:type="paragraph" w:default="1" w:styleId="Normal">
    <w:name w:val="Normal"/>
    <w:qFormat/>
    <w:rPr><w:lang w:val="tr-TR"/></w:rPr>
    <w:pPr><w:spacing w:after="220" w:line="360" w:lineRule="auto"/></w:pPr>
  </w:style>
</w:styles>`;

      const relsXml =
`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/>
</Relationships>`;

      const contentTypes =
`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
  <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
  <Default Extension="xml" ContentType="application/xml"/>
  <Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/>
  <Override PartName="/word/styles.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.styles+xml"/>
</Types>`;

      zip.folder("_rels").file(".rels", relsXml);
      zip.folder("word").file("document.xml", documentXml);
      zip.folder("word").file("styles.xml", stylesXml);
      zip.file("[Content_Types].xml", contentTypes);

      return await zip.generateAsync({ type: "arraybuffer" });
    }

    // --- DOCX kaydet: ilk başlık dosya adı ---
    $("#saveDocx").addEventListener("click", async ()=>{
      const text = $("#editor").value.trim() || " ";
      let firstLine = text.split(/\r?\n/).find(line => line.trim() !== "") || "roman";
      firstLine = firstLine.replace(/[<>:"/\\|?*\x00-\x1F]/g, "").trim();
      if (!firstLine) firstLine = "roman";

      const ab = await buildDocx(text);
      const blob = new Blob([ab], {
        type: "application/vnd.openxmlformats-officedocument.wordprocessingml.document"
      });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = firstLine + ".docx";
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
      a.remove();
    });

    // --- Drive / Docs'tan çekme (API'siz) ---
    function parseGoogleUrl(u){
      try{
        const url = new URL(u);
        const h = url.hostname;
        const p = url.pathname;
        const qid = url.searchParams.get("id");

        // Google Docs (document)
        const mDocs = p.match(/\/document\/d\/([a-zA-Z0-9_-]+)/);
        if (h.includes("docs.google.") && mDocs) {
          return { kind:"gdocs", id:mDocs[1] };
        }

        // Drive paylaşımlı dosya (file/d/ID)
        const mDrive = p.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
        if (h.includes("drive.google.") && mDrive) {
          return { kind:"gdrive", id:mDrive[1] };
        }

        // Drive ?id=ID
        if (h.includes("drive.google.") && qid) {
          return { kind:"gdrive", id: qid };
        }
      }catch(e){}
      return null;
    }

    async function fetchTextFromPublic(url){
      const meta = parseGoogleUrl(url);
      if(!meta) throw new Error("Bağlantı çözümlenemedi. Lütfen Google Docs veya Drive paylaşım linki verin.");

      let tryUrls = [];

      if (meta.kind === "gdocs") {
        // Doğrudan TXT export
        tryUrls.push(`https://docs.google.com/document/d/${meta.id}/export?format=txt`);
        // CORS yedeği (salt okunur proxy)
        tryUrls.push(`https://r.jina.ai/http://docs.google.com/document/d/${meta.id}/export?format=txt`);
      } else if (meta.kind === "gdrive") {
        // Drive dosyalarında yalnızca .txt ise metin çekilebilir
        // (docx içeriğini tarayıcıda metne çevirmek yok; docx'i indirip açabilirsin)
        tryUrls.push(`https://drive.google.com/uc?export=download&id=${meta.id}`);
        tryUrls.push(`https://r.jina.ai/http://drive.google.com/uc?export=download&id=${meta.id}`);
      }

      let lastErr;
      for(const turl of tryUrls){
        try{
          const r = await fetch(turl);
          if(!r.ok) throw new Error("HTTP " + r.status);
          const ct = r.headers.get("content-type") || "";
          // Yalnızca metin içerik
          if (!/text|plain|utf-8|json/.test(ct) && !turl.includes("r.jina.ai")) {
            // muhtemelen binary (ör. docx) — metne çeviremeyiz
            throw new Error("Bu Drive dosyası metin değil (ör. DOCX). Lütfen Google Docs bağlantısı ya da .txt verin.");
          }
          const txt = await r.text();
          return txt;
        }catch(e){
          lastErr = e;
        }
      }
      throw lastErr || new Error("İçerik alınamadı.");
    }

    $("#fetchDrive").addEventListener("click", async ()=>{
      const url = $("#driveUrl").value.trim();
      const st = $("#fetchStatus");
      if(!url){ st.textContent = "Lütfen bağlantıyı yapıştırın."; return; }

      st.textContent = "Yükleniyor…";
      try{
        const txt = await fetchTextFromPublic(url);
        $("#editor").value = txt.trim();
        st.textContent = "Metin yüklendi.";
      }catch(err){
        st.textContent = "Hata: " + (err?.message || "İçerik alınamadı.");
      }
    });

    // Butonlar
    $("#toNovel").addEventListener("click", ()=>{
      const v = $("#editor").value;
      $("#editor").value = toNovelFormat(v);
    });
    $("#detectHeads").addEventListener("click", ()=>{
      const v = $("#editor").value;
      $("#editor").value = detectHeads(v);
    });
    $("#clear").addEventListener("click", ()=> $("#editor").value = "");

    // Mobil odak
    window.addEventListener("load", ()=>$("#editor").focus(), { once:true });
  </script>
</body>
</html>
